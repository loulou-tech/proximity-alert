<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Radars - Proximité</title>
</head>
<body>
    <h1>Carte des Radars en France</h1>
    <p>Cette carte affiche les radars en France et vous alerte lorsque vous vous approchez d'un radar.</p>

    <h2>Votre Position et Alerte Sonore</h2>
    <p>Votre position est détectée ci-dessous, et une alerte sonore sera déclenchée lorsque vous vous approcherez des radars.</p>

    <!-- Zone pour afficher la carte centrée sur la position de l'utilisateur -->
    <div id="map" style="height: 500px; width: 100%;"></div>

    <script>
        var map;
        var userMarker;

		// Fonction d'initialisation de la carte pour afficher la position de l'utilisateur
        function initMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(onPositionReceived, onPositionError);
            } else {
                alert("La géolocalisation n'est pas supportée par ce navigateur.");
            }
        }

        function onPositionReceived(position) {
            var userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            if (!map) {
                initializeMap(userLocation);
                addUserMarker(userLocation);
                addRadarMarkers();
            } else {
                updateUserMarker(userLocation);
            }
            checkProximity(userLocation);

            // Rafraîchir la position de l'utilisateur toutes les 3 secondes
            setTimeout(function() {
                navigator.geolocation.getCurrentPosition(onPositionReceived, onPositionError);
            }, 3000);
        }

        function onPositionError() {
            alert("Erreur de géolocalisation.");
        }

        function initializeMap(userLocation) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: userLocation,
                zoom: 14
            });
        }

        function addUserMarker(userLocation) {
            const icon = {
                url: "./images/position.png",
                scaledSize: new google.maps.Size(50, 50),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(25, 25)
            };

            userMarker = new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: icon,
                title: 'Vous êtes ici'
            });
        }

        function updateUserMarker(userLocation) {
            userMarker.setPosition(userLocation);
            map.setCenter(userLocation);
        }

        function addRadarMarkers() {
            radarMarkers.forEach(function(radar) {
                new google.maps.Marker({
                    position: radar,
                    map: map,
                    title: radar.title
                });
            });
        }

        // Fonction pour vérifier la proximité et jouer un son
        function checkProximity(userLocation) {
            radarMarkers.forEach(function(radar) {
                var userLatLng = new google.maps.LatLng(userLocation.lat, userLocation.lng);
                var radarLatLng = new google.maps.LatLng(radar.lat, radar.lng);

                var distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, radarLatLng);
                console.log("Distance au radar : " + distance + " mètres");

                // Si la distance est inférieure à 500 mètres, jouer un son
                if (distance < 500) {
                    playSound();
                }
            });
        }

        // Fonction pour jouer un son
        function playSound() {
            var audio = new Audio('./ALRMClok.wav');
            audio.play();
        }

        // Initialisation de la carte à la charge de la page
        window.onload = initMap;
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGFywqcaiCQdZTSyzkIUnHA3twrdwY8mo&libraries=geometry"></script>
</body>
</html>
